<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LHCb Starterkit: Second analysis steps</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css" />
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     ga('create', 'UA-63818884-1', 'auto');
     ga('send', 'pageview');
    </script>
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="https://lhcb.github.io/second-analysis-steps/">
          <img src="img/starterkit.png" height="100" alt="LHCb Starterkit">
        </a>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1 class="title">Second analysis steps</h1>
          <h2 class="subtitle">Using Ganga with local projects</h2>
<div id="learning-objectives" class="objectives panel panel-warning">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-certificate"></span>Learning Objectives</h2>
</div>
<div class="panel-body">
<ul>
<li>Submit jobs using Ganga that use local LHCb projects containing your own modifications</li>
</ul>
</div>
</div>
<p>Before starting, you should read the <a href="01-managing-files-with-ganga.html">first Ganga lesson</a>, which gives some advice about choosing a Ganga version, making a clean environment for running Ganga in, and where to go to get help when things in Ganga go wrong.</p>
<p>The <code>lb-dev</code> command allows you to start hacking on LHCb code very quickly. The downside is that Ganga does not yet support the use of local projects created with <code>lb-dev</code> when you run an application.</p>
<p>In this lesson, we will go through a workaround that will allow you to use local projects with Ganga jobs, wherever they run.</p>
<div id="how-things-used-to-be" class="callout panel panel-info">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-pushpin"></span>How things used to be</h2>
</div>
<div class="panel-body">
<p>Before <code>lb-dev</code> was available, local projects would conventionally live in the <code>~/cmtuser</code> folder. A local DaVinci v36r5 project, for example, would be at <code>~/cmtuser/DaVinci_v36r5</code>, within which one could checkout sub-packages, edit them, and compile the main package. Running things like <code>gaudirun.py</code> would then pick up the local version of DaVinci, similarly to how the <code>./run</code> command does things today.</p>
<p>Ganga only supports this ‘cmtuser-style’ of local projects. If you create a <code>Job</code> with a <code>DaVinci(version='v36r5')</code> application, Ganga will automatically use the local version of DaVinci in <code>~/cmtuser</code>, and will even ship this to the Grid of your job will run there. The Ganga developers are <a href="https://github.com/ganga-devs/ganga/issues/73">working on <code>lb-dev</code> support</a>.</p>
<p>The use of ‘cmtuser-style’ projects created with <code>SetupProject</code> is discouraged by everyone else in favour of <code>lb-dev</code>, so try not to use it if at all possible.</p>
</div>
</div>
<p>We will create a local version of DaVinci with some modified algorithm, so that we can check that Ganga is using the local version when we submit a job. First, we'll create a local DaVinci with <code>lb-dev</code>, and will then fetch the [<code>DecayTreeTuple</code>][dtt-package], which lives under the <code>Phys</code> hat.</p>
<pre class="shell"><code>$ lb-dev DaVinci v40r1p3
$ cd DaVinciDev_v40r1p3
$ getpack Phys/DecayTreeTuple v5r6</code></pre>
<p>We will do something silly as a test: add a <code>_2M</code> branch to <code>TupleToolKinematic</code> that fills twice the invariant mass of the particle. To do this, we just need to edit the implementation file at <code>src/TupleToolKinematic.cpp</code>. Line 76 of that file reads like this:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp">test &amp;= tuple-&gt;column( prefix+<span class="st">&quot;_M&quot;</span>, P-&gt;momentum().M() );</code></pre>
<p>Here, <code>tuple</code> is a object representing the ntuple to be filled, and the <code>column</code> method tells the ntuple to fill the branch named by the first argument (a <code>string</code>) with the value of the second argument. Create a line just below this one, using <code>_2M</code> as the branch name suffix as twice the particle mass as the value.</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp">test &amp;= tuple-&gt;column( prefix+<span class="st">&quot;_2M&quot;</span>, <span class="dv">2</span>*P-&gt;momentum().M() );</code></pre>
<p>Then we just need to compile our local DaVinci package. You must be in the <code>DaVinci_v40r1p3</code> when executing the following commands:</p>
<pre class="shell"><code># Using -j8 runs up to 8 tasks in parallel, speeding up the build
$ make -j8
$ make install</code></pre>
<p>This will create a folder called <code>InstallArea</code>. Ganga needs to know about this folder a couple of others to use the local project. We will create <a href="https://kb.iu.edu/d/abbe">symbolic links</a> to these folders in the place that Ganga looks.</p>
<pre class="shell"><code>$ mkdir -p ~/cmtuser/DaVinci_v40r1p3
$ cd ~/cmtuser/DaVinci_v40r1p3
$ ln -s ~/DaVinciDev_v40r1p3/cmt
$ ln -s ~/DaVinciDev_v40r1p3/DaVinciDevSys
$ ln -s ~/DaVinciDev_v40r1p3/InstallArea
$ ls -la
drwxr-xr-x.  2 username z5 2048 May 19 09:05 .
drwxr-xr-x.  2 username z5 2048 May 19 09:05 ..
lrwxr-xr-x.  1 username z5   58 May 19 09:05 cmt -&gt; /afs/cern.ch/user/a/apearce/DaVinciDev_v40r1p3/cmt
lrwxr-xr-x.  1 username z5   58 May 19 09:05 DaVinciDevSys -&gt; /afs/cern.ch/user/a/apearce/DaVinciDev_v40r1p3/DaVinciDevSys
lrwxr-xr-x.  1 username z5   58 May 19 09:05 InstallArea -&gt; /afs/cern.ch/user/a/apearce/DaVinciDev_v40r1p3/InstallArea</code></pre>
<p>You can see the link in the output of <code>ls -la</code>. For example, the arrow <code>-&gt;</code> says that <code>InstallArea</code> is a link to our <code>InstallArea</code> created by <code>lb-dev</code>.</p>
<p>Now we can proceed as usual, defining a job running DaVinci in Ganga.</p>
<pre class="shell"><code>$ lb-run Ganga v601r19 ganga</code></pre>
<pre><code>j = Job(name=&#39;Local_DaVinci_Test&#39;)
j.application = DaVinci(version=&#39;v40r1p3&#39;)
j.applications.optsfile = [...]
j.inputdata = [...]
j.outputfiles = [LocalFile(&#39;*.root&#39;)]
j.submit()</code></pre>
<p>You can then confirm that you have a <code>_2M</code> branch in your output ROOT file.</p>
<div id="you-know-what-to-do" class="challenge panel panel-success">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-pencil"></span>You know what to do</h2>
</div>
<div class="panel-body">
<p>To test this, we need an options file that defines a <code>DecayTreeTuple</code>, and some data to run over. You know how to write options files so you can do this yourself. You could re-use an options file that we made previously, and use the same data.</p>
</div>
</div>
<div id="warning" class="callout panel panel-info">
<div class="panel-heading">
<h2><span class="glyphicon glyphicon-pushpin"></span>Warning</h2>
</div>
<div class="panel-body">
<p>This is a workaround and is not a permanent solution. You have to be careful when using this method, as things other than Ganga also look in <code>~/cmtuser</code> for existing projects when building and configuring. The <code>lb-dev</code> tool is one of these things. The folder in <code>~/cmtuser</code> <strong>should be deleted after submitting the job</strong> in Ganga to stop it interfering with anything else.</p>
</div>
</div>
        </div>
      </div>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/lhcb/first-analysis-steps">Source</a>
        <a class="label swc-blue-bg" href="mailto:lhcb-starterkit@cern.ch">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/contrib/auto-render.min.js"></script>
    <script>
      // Go KaTeX go!
      renderMathInElement(document.body);
    </script>
  </body>
</html>
